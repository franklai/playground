<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>公共自行車資訊</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.js"
      integrity="sha256-cyY9tyQbycFc+9eOsamJ8K8wmBsMcsXgxS9nLLkqK+I="
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        padding: 10px 0;
        max-width: 320px;
        margin: 0 auto;
      }
      #bike-container {
        display: grid;
        grid-template-columns: 200px 60px 60px;
        align-items: center;
        margin: 0 auto;
        grid-row-gap: 1rem;
      }
      .name {
        text-align: right;
      }
      .bike,
      .space {
        font-size: 1.4rem;
        font-weight: bold;
        text-align: center;
      }
      .bike {
        color: green;
      }
      .space {
        color: grey;
      }
      .limited {
        color: orange !important;
      }

      input[type="button"] {
        font-size: 1.2rem;
        padding: 0.2rem 1.6rem;
        border-radius: 1rem;
        border-style: solid;
        border-color: black;
        border-width: 0.2rem;
        background-color: transparent;
        margin-right: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="root">
      <h1>公共自行車資訊</h1>

      <div id="button-container">
        <input type="button" id="refresh" value="更新" />
        <span id="refresh-status"></span>
      </div>
      <div id="bike-container">
        <div class="name">捷運高鐵桃園站(A18)</div>
        <div class="bike">-</div>
        <div class="space">-</div>
      </div>
    </div>
    <script type="application/javascript">
      const getAuthorizationHeader = () => {
        const appId = "FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF";
        const appKey = "FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF";
        const gmtString = new Date().toGMTString();
        const shaObj = new jsSHA("SHA-1", "TEXT");
        shaObj.setHMACKey(appKey, "TEXT");
        shaObj.update("x-date: " + gmtString);

        const hmac = shaObj.getHMAC("B64");
        const authorization = `hmac username="${appId}", algorithm="hmac-sha1", headers="x-date", signature="${hmac}"`;

        return { authorization, gmtString };
      };

      const appendParameters = (baseUrl, params) => {
        const urlParams = new URLSearchParams();
        for (const [key, value] of Object.entries(params)) {
          urlParams.set(key, value);
        }
        const url = `${baseUrl}?${urlParams.toString()}`;
        return url;
      };

      const generalFetch = async (url) => {
        const { authorization, gmtString } = getAuthorizationHeader();

        const headers = {
          Accept: "application/json",
          Authorization: authorization,
          "X-Date": gmtString,
        };

        const resp = await fetch(url, {
          headers: headers,
        });

        const myJson = await resp.json();

        return myJson;
      };

      const fetchStations = async (stations) => {
        const result = [];
        for (const {city, ids} of stations) {
          result.push(...(await fetchStationById(city, ids)));
        }
        return result;
      };

      const fetchStationById = async (city, ids) => {
        const baseUrl = `http://ptx2.transportdata.tw/MOTC/v2/Bike/Station/${city}`;
        const params = {
          $top: 10,
          $format: "JSON",
        };

        params["$filter"] = ids
          .map((id) => `StationID eq '${id}'`)
          .join(" or ");
        const url = appendParameters(baseUrl, params);
        const myJson = await generalFetch(url);

        return myJson;
      };

      const fetchStationAvailability = async (stations) => {
        const result = [];
        for (const {city, ids} of stations) {
          result.push(...(await fetchStationAvailabilityById(city, ids)));
        }
        return result;
      };
      const fetchStationAvailabilityById = async (city, ids) => {
        const baseUrl = `http://ptx2.transportdata.tw/MOTC/v2/Bike/Availability/${city}`;
        const params = {
          $top: 10,
          $format: "JSON",
        };

        params["$filter"] = ids
          .map((id) => `StationID eq '${id}'`)
          .join(" or ");
        const url = appendParameters(baseUrl, params);
        const myJson = await generalFetch(url);

        return myJson;
      };

      const drawBikeAvailability = (stations, availability) => {
        const map = {};

        stations.forEach((item) => {
          map[item.StationID] = {
            name: item.StationName.Zh_tw,
          };
        });

        availability.forEach((item) => {
          const station = map[item.StationID];
          if (!station) {
            console.error(`failed to find station, id: ${item.StationID}`);
            return;
          }

          station.bike = item.AvailableRentBikes;
          station.space = item.AvailableReturnBikes;
        });

        const htmlLines = [];

        htmlLines.push('<div class="name">站名</div>');
        htmlLines.push('<div class="bike">車輛</div>');
        htmlLines.push('<div class="space">空位</div>');
        Object.values(map).forEach((station) => {
          const limited_bike_class = station.bike < 10 ? "limited" : "";
          const limited_space_class = station.space < 10 ? "limited" : "";
          htmlLines.push(`<div class="name">${station.name}</div>`);
          htmlLines.push(
            `<div class="bike ${limited_bike_class}">${station.bike}</div>`
          );
          htmlLines.push(
            `<div class="space ${limited_space_class}">${station.space}</div>`
          );
        });

        const html = htmlLines.join("\n");
        const container = document.querySelector("#bike-container");
        container.innerHTML = html;
      };

      const updateRefreshStatus = (text) => {
        document.querySelector("#refresh-status").innerHTML = text;
      };

      const setRefreshing = () => {
        updateRefreshStatus("更新中");
      };

      const setRefreshTime = () => {
        const text = `${new Date().toLocaleString()}`;
        updateRefreshStatus(text);
      };

      const doQuery = async (input) => {
        setRefreshing();
        const stations = await fetchStations(input);
        const availability = await fetchStationAvailability(input);

        await drawBikeAvailability(stations, availability);
        setRefreshTime();
      };

      const initButtonHandler = (stations) => {
        document.querySelector("#refresh").addEventListener("click", () => {
          doQuery(stations);
        });
      };

      (async () => {
        const stations = [
          {
            city: "NewTaipei",
            ids: [
              1266, // 捷運林口站(1號出口)
              1378, // 三井Outlet
            ],
          },
          {
            city: "Taoyuan",
            ids: [
              2100, // 捷運高鐵桃園站(A18)
              2212, // 青塘園
              2101, // 捷運桃園體育園區站(A19)
              2343, // 高鐵桃園站(3號出口)
            ],
          },
        ];

        initButtonHandler(stations);

        await doQuery(stations);
      })();
    </script>
  </body>
</html>
